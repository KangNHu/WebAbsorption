package com.liveeeasy.web.absorption.demo.spider.wuba;import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONArray;import com.alibaba.fastjson.JSONObject;import com.liveeasy.web.absorption.core.annotation.SPI;import com.liveeasy.web.absorption.core.processor.SimpleWebAbsorptionProcessor;import org.apache.commons.lang3.StringUtils;import org.springframework.util.CollectionUtils;import us.codecraft.webmagic.Page;import java.util.ArrayList;import java.util.List;@SPI("wuBaSpider")public class WuBaProcessor extends SimpleWebAbsorptionProcessor {    @Override    public boolean process(Page page) {        String url = page.getRequest().getUrl();        if(!StringUtils.isEmpty(page.getHtml().regex("访问过于频繁，本次访问做以下验证码校验").get())){            throw new RuntimeException("请求被拦截，需要输入验证码");        }        if("https://wh.58.com/xiaoqu/".equals(url)) {            List<String> values = page.getHtml().xpath("//div[@class='filter-wrap']//a[@class='path_link']/@value").all();            List<String> areaUrl = new ArrayList<>();            for (int i = 0 , length = values.size() ; i < length ; i ++){                String areaID = values.get(i).trim();                if(!StringUtils.isEmpty(areaID)) {                    areaUrl.add(url + values.get(i).trim() + "/");                }            }            page.addTargetRequests(areaUrl);        }else if(url.matches("https://wh.58.com/xiaoqu/[0-9]+/") ||                url.matches("https://wh.58.com/xiaoqu/[0-9]+/pn_[0-9]+/")){            String nextPage = "";            List<String> all = page.getHtml().xpath("//ul[@class='xq-list-wrap']//li//h2[@class='title']/a/@href").all();            if(url.matches("https://wh.58.com/xiaoqu/[0-9]+/")){                nextPage = url + "pn_2/";            }else {                if(!CollectionUtils.isEmpty(all)){                    String[] urls = url.split("pn_");                    String baseUrl = urls[0];                    int pageNo =  Integer.parseInt(urls[1].replace("/" , "")) +1;                    nextPage = baseUrl + "pn_" + pageNo +"/";                }else {                    return false;                }            }            page.addTargetRequest(nextPage);            page.addTargetRequests(all);        }else if(page.getRequest().getUrl().matches("https://wh.58.com/xiaoqu/[a-z0-9]+/")){            List<String> all = page.getHtml().xpath("//table[@class='info-tb']//tr/td[@class='desc']/@title").all();            if(all != null && all.size() >=15){                String[] areaAndShopping = all.get(0).split("\\s");                page.putField("area" , areaAndShopping[0]);                if(areaAndShopping.length == 2) {                    page.putField("shopping", areaAndShopping[1]);                }                page.putField("detailed_address" , all.get(1));                page.putField("building_types" , all.get(2));                page.putField("total_number_of_households" , all.get(3));                page.putField("property_categorproperty_category" , all.get(4));                page.putField("property_cost" , all.get(5));                page.putField("period_int" , all.get(6));                page.putField("plot_ratio" , all.get(7));                page.putField("building_age" , all.get(8));                page.putField("greening_rate" , all.get(9));                page.putField("occupied_area" , all.get(10));                page.putField("floor_area" ,all.get(11) );                page.putField("arking_spot" , all.get(12));                page.putField("property_company" , all.get(13));                page.putField("developers" , all.get(14));            }            page.putField("community_introduction" , page.getHtml().xpath("//div[@class='detail-container']//p[@class='desc']/text()").get());            page.putField("building_name" , page.getHtml().xpath("//div[@class='title-bar']/span[@class='title']/text()").get());            page.putField("lon" , page.getHtml().regex("lon:\\s+\"([0-9.]*)\"" , 1).get());            page.putField("lat" , page.getHtml().regex("lat:\\s+\"([0-9.]*)\"" , 1).get());            page.putField("type" , "data_base");            String infoId = page.getHtml().regex("infoid:\\s+\"([0-9.]*)\"").get();            page.putField("infoId",infoId);            if(!StringUtils.isEmpty(infoId)) {                page.addTargetRequest("https://m.58.com/xiaoquweb/getXiaoquPics/?infoid=" + infoId);                page.addTargetRequest("https://m.58.com/xiaoquweb/getCommExpertList/?infoid=" + infoId);            }        }else if(page.getRequest().getUrl().matches("https://m.58.com/xiaoquweb/getXiaoquPics/.infoid=[0-9]+")){            String rawText = page.getRawText();            page.putField("type" , "data_pic");            page.putField("images" ,  rawText);            page.putField("infoId" , page.getRequest().getUrl().split("=")[1]);        }else if(page.getRequest().getUrl().matches("https://m.58.com/xiaoquweb/getCommExpertList/.infoid=[0-9]+")){            String rawText = page.getRawText();            page.putField("type" , "data_expert");            page.putField("expert_interpretation" , rawText);            page.putField("infoId" , page.getRequest().getUrl().split("=")[1]);        }        return false;    }}